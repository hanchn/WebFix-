## 1. 问题背景

CDN（内容分发网络）通过分布在全球的**边缘节点**缓存主站的内容（如图片、JS、CSS、页面），加速访问。

* 当主站内容变更（比如你更新了静态资源、文章、图片），**CDN 节点的缓存还是旧的**。
* 如果用户访问的还是边缘节点的旧缓存，体验就“卡壳”了。

所以需要**让CDN节点上的缓存内容“失效/刷新”**，让他们去主站重新拉新内容。

---

## 2. 常见的CDN缓存刷新机制

### 方式一：**CDN管理后台/接口主动刷新**

* 绝大多数 CDN（如阿里云、腾讯云、Cloudflare、Akamai、AWS）都支持**API 或控制台“刷新缓存”**（Purge/Refresh）。

  * 支持刷新某个路径、某个目录、全站、或者指定文件。
  * 一般通过CDN控制台手动发起，或者写自动化脚本/CI流程通过API调用。
* 实战常用场景：前端静态资源自动化发布完成后，CI/CD工具自动调用CDN刷新接口。

#### 典型API调用（以阿里云为例）：

```bash
aliyuncdn RefreshObjectCaches --ObjectPath "https://xxx.com/static/main.123abc.js" --ObjectType "File"
```

* 也可以用SDK、HTTP请求等方式自动刷新。

---

### 方式二：**设置合理的缓存过期时间+文件名hash**

* 发布新内容时，静态资源加 hash（如 main.abc123.js），每次内容变了文件名也变，这样根本不用担心缓存过期——新文件URL用户一定能访问到最新内容，老缓存文件会自然失效。
* 这种方式对“旧文件强制下线”不友好，但对CDN压力最小，常用于大规模前端应用。

---

### 方式三：**回源时响应头控制缓存**

* 后端响应头控制（如 `Cache-Control: max-age=xxx`、`no-cache`、`must-revalidate`），影响CDN边缘节点是否和主站同步校验内容。
* 这种方式受限于CDN厂商配置和策略，不适合大批量、紧急刷新。

---

### 方式四：**主动下发刷新信号（回源/回包刷新）**

* 有些企业会做“刷新通知”系统，主站内容发布后主动调用各CDN节点API，或者“回源”时让节点发现主站内容已变（如加版本号、hash、last-modified），让CDN节点自动丢弃老缓存。
* 有些厂商支持“回源回包刷新”，即主站加特定Header通知CDN失效缓存。

---

## 3. 实战建议与自动化

* **推荐**：结合发布流程自动化CDN刷新。

  * 发布新内容 → 部署成功 → 自动调用CDN刷新API → 监控刷新任务状态。
* 配合 hash 文件名，最大化兼容缓存和新内容一致性。
* 大型站点/高QPS时，**批量刷新需分批**，防止CDN压力过大。
* 如果业务有强一致性需求，比如敏感资讯、广告、证券行情等，必须用API主动刷新。

---

## 4. 常见“踩坑”点

* **CDN刷新不是实时生效**：通常需要几秒到几分钟（视节点分布/数量），全球同步可能有延迟。
* **全站刷新代价大**，不建议频繁操作，容易被限流或额外付费。
* 某些CDN厂商刷新API有QPS、次数限制，建议合理分批。
* **动态内容/接口返回也可能被CDN缓存**，需要和静态资源刷新区分对待。

---

## 5. 总结一句话

> **主站内容更新后，应通过CDN厂商提供的“主动刷新API”批量或定向通知边缘节点清理/失效对应缓存，加上合理缓存策略和自动化CI/CD管控，确保全球节点能尽快同步最新内容。**
